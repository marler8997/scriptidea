#!/usr/bin/env stitch
#
# Example ported from: https://www.linode.com/docs/guides/solving-real-world-problems-with-bash-scripts-a-tutorial/
#

# a couple of lines I added to setup a scratch dir
rm -rf @scriptdir/scratch
mkdir @scriptdir/scratch

#$set f /home/mtsouk/connections.data
f = @scriptdir/scratch/log

# TODO: fix implementation to not require parens here
@if @not (@isfile $f)
    @echo $f does not exist!
@end

touch $f
maxsize = (expr 4096 * 1024)

@echo DEBUG: "maxsize="$maxsize

# TODO: need piping
#size=`du -b ${f} | tr -s '\t' ' ' | cut -d' ' -f1`
size = (du -b $f)
@echo DEBUG: A: "size="$size
#size = (tr -s '\t' ' ' $size)
#@echo DEBUG: B: "size="$size


# NOTE: for now just hardcode the size until piping is implemented
size = (expr 4096 * 1025)

@if $size @gt $maxsize
    @echo Rotating!
    timestamp = (date +%s)
    mv $f $f$.$timestamp
    touch $f
@end
